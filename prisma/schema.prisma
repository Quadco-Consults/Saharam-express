// Saharam Express Ticketing System
// Prisma Schema for PostgreSQL (Aiven)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  CUSTOMER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum VehicleStatus {
  ACTIVE
  MAINTENANCE
  INACTIVE
}

enum VehicleType {
  SIENNA
  BUS
  SALON_CAR
  HIACE
  COASTER
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
}

enum NotificationType {
  SMS
  EMAIL
  PUSH
}

enum PaymentReceiptStatus {
  PENDING
  APPROVED
  REJECTED
}

// Models
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String?
  firstName     String?
  lastName      String?
  phone         String?
  role          UserRole @default(CUSTOMER)
  loyaltyPoints Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  bookings                 Booking[]
  loyaltyTransactions      LoyaltyTransaction[]
  supportTickets           SupportTicket[]
  supportMessages          SupportMessage[]
  notifications            Notification[]
  adminSettingsUpdated     AdminSetting[]
  uploadedPaymentReceipts  PaymentReceipt[] @relation("PaymentReceiptUploader")
  verifiedPaymentReceipts  PaymentReceipt[] @relation("PaymentReceiptVerifier")

  @@map("users")
}

model Route {
  id                String   @id @default(cuid())
  fromCity          String
  toCity            String
  distance          Int // in kilometers
  estimatedDuration Int // in minutes
  basePrice         Decimal  @db.Decimal(10, 2)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  trips Trip[]

  @@unique([fromCity, toCity])
  @@map("routes")
}

model Vehicle {
  id              String        @id @default(cuid())
  plateNumber     String        @unique
  model           String
  vehicleType     VehicleType   @default(HIACE)
  capacity        Int
  year            Int?
  status          VehicleStatus @default(ACTIVE)
  lastMaintenance DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  trips Trip[]

  @@map("vehicles")
}

model Driver {
  id            String       @id @default(cuid())
  firstName     String
  lastName      String
  phone         String
  email         String?
  licenseNumber String       @unique
  licenseExpiry DateTime
  status        DriverStatus @default(ACTIVE)
  rating        Decimal      @default(5.00) @db.Decimal(3, 2)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  trips Trip[]

  @@map("drivers")
}

model Trip {
  id             String   @id @default(cuid())
  routeId        String
  vehicleId      String
  driverId       String?
  departureTime  DateTime
  arrivalTime    DateTime
  basePrice      Decimal  @db.Decimal(10, 2)
  availableSeats Int
  totalSeats     Int
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  route        Route         @relation(fields: [routeId], references: [id], onDelete: Cascade)
  vehicle      Vehicle       @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  driver       Driver?       @relation(fields: [driverId], references: [id], onDelete: SetNull)
  bookings     Booking[]
  seatBookings SeatBooking[]

  @@map("trips")
}

model Booking {
  id                  String        @id @default(cuid())
  userId              String?
  tripId              String
  bookingReference    String        @unique
  passengerName       String
  passengerPhone      String
  passengerEmail      String?
  seatNumbers         String[]
  totalAmount         Decimal       @db.Decimal(10, 2)
  paymentMethod       String?
  paymentReference    String?
  status              BookingStatus @default(PENDING)
  paymentStatus       PaymentStatus @default(PENDING)
  qrCode              String?
  loyaltyPointsEarned Int           @default(0)
  loyaltyPointsUsed   Int           @default(0)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relations
  user                 User?                @relation(fields: [userId], references: [id], onDelete: SetNull)
  trip                 Trip                 @relation(fields: [tripId], references: [id], onDelete: Cascade)
  seatBookings         SeatBooking[]
  loyaltyTransactions  LoyaltyTransaction[]
  supportTickets       SupportTicket[]
  paymentReceipt       PaymentReceipt?

  @@map("bookings")
}

model SeatBooking {
  id         String   @id @default(cuid())
  tripId     String
  bookingId  String
  seatNumber String
  createdAt  DateTime @default(now())

  // Relations
  trip    Trip    @relation(fields: [tripId], references: [id], onDelete: Cascade)
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@unique([tripId, seatNumber])
  @@map("seat_bookings")
}

model LoyaltyTransaction {
  id              String   @id @default(cuid())
  userId          String
  bookingId       String?
  pointsChange    Int // positive for earned, negative for used
  transactionType String // 'earned', 'used', 'expired'
  description     String?
  createdAt       DateTime @default(now())

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@map("loyalty_transactions")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String?
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  sentAt    DateTime?
  createdAt DateTime         @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model AdminSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  updatedByUser User? @relation(fields: [updatedBy], references: [id])

  @@map("admin_settings")
}

model SupportTicket {
  id         String   @id @default(cuid())
  userId     String?
  bookingId  String?
  subject    String
  message    String
  priority   String   @default("medium")
  status     String   @default("open")
  assignedTo String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user     User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  booking  Booking?          @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  messages SupportMessage[]

  @@map("support_tickets")
}

model SupportMessage {
  id         String   @id @default(cuid())
  ticketId   String
  userId     String
  message    String
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("support_messages")
}

model PaymentReceipt {
  id               String               @id @default(cuid())
  bookingId        String               @unique
  receiptUrl       String // URL to the uploaded receipt image
  fileName         String // Original filename
  fileSize         Int // File size in bytes
  mimeType         String // File MIME type (image/png, image/jpeg, etc.)
  status           PaymentReceiptStatus @default(PENDING)
  uploadedBy       String? // User ID who uploaded (for guest bookings, can be null)
  verifiedBy       String? // Admin user ID who verified
  verificationNote String? // Admin notes during verification
  rejectionReason  String? // Reason for rejection if status is REJECTED
  amountPaid       Decimal?             @db.Decimal(10, 2) // Amount shown in receipt
  transferDate     DateTime? // Date of transfer as shown in receipt
  senderAccount    String? // Sender account details from receipt
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  // Relations
  booking    Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  uploader   User?   @relation("PaymentReceiptUploader", fields: [uploadedBy], references: [id], onDelete: SetNull)
  verifier   User?   @relation("PaymentReceiptVerifier", fields: [verifiedBy], references: [id], onDelete: SetNull)

  @@map("payment_receipts")
}